<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="application/javascript" src="index.js"></script>
    <title>Title</title>
    <style>
        body {
            margin: 0;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            font-family: sans-serif;
            box-sizing: border-box;
        }
        .header {
            background-color: #f4f4f4;
            box-shadow: 0 2px 6px #cfcfcf;
            padding: 56px 51px 20px 51px;
        }
        .search, .controls {
            display: inline-block;
        }
        .search {
            float: right;
        }
        .controls button {
            background-color: #0271c7;
            color: #fff;
            width: 80px;
            height: 25px;
            margin-right: 10px;
            border-radius: 2px;
            border-style: none;
            box-shadow: 0 2px 6px #cfcfcf;
        }
        .container {
            padding: 15px 50px 0 50px;
        }
        .nav-btn {
            background-color: #fff;
            color: #666;
            height: 17px;
            text-align: center;
            display: inline;
            box-shadow: inset 0px 0px 7px #9e9e9e;
            border-radius: 4px;
            padding-bottom: 5px;
            padding-top: 5px;
            padding-left: 8px;
            padding-right: 8px;
            margin-right: 8px;
        }
        .date {
            margin-right: 8px;
        }
        .calendar {
            margin-top: 15px;
        }
        .calendar table {
            border-collapse: collapse;
        }
        #calend td.cell {
            width: 128px;
            font-size: 14px;
            color: #999999;
            min-height: 110px;
            height: 110px;
            border: 1px solid #ebebeb;
            padding-top: 10px;
            padding-left: 10px;
        }
        #calend td.cell.current {
            background-color: #f4f4f4;
        }
        #calend td.cell.active {
            background-color: #c2e4fe;
        }
        #calend td.cell.current .cell-number {
            font-weight: bold;
        }
        .events .event.title {
            font-weight: bold;
        }
        div.cell-number {
            display: inline-block;
        }
        div.events {
            height: 80%;
        }
        .modal-form {
            display: none;
            box-shadow: 0px 0px 8px #ededed;
            border: 1px solid #cfcfcf;
            width: 303px;
            height: 330px;
            padding: 10px 10px 65px 20px;
            box-sizing: border-box;
            background-color: #fff;
            position: absolute;
            left: 0px;
            top: 0px;
        }
        .modal-close.icon {
            display: block;
            text-align: right;
            width: 100%;
            font-size: 9px;
            margin-bottom: 5px;
        }
        .input-field {
            width: 98%;
            border: none;
            box-sizing: border-box;
            margin: 0 2px;
        }
        input:focus, textarea:focus {
            outline: none;
        }
        .text-field {
            resize: none;
            width: 98%;
            height: 97%;
            border: none;
            box-sizing: border-box;
            margin: 2px 2px;
        }
        .field-container.descr {
            margin-top: 30px;
            max-height: 115px;
            height: 115px;
        }
        .field-container {
            margin-bottom: 5px;
            box-shadow: inset 0px 0px 3px #9e9e9e;
            width: 255px;
            border-radius: 4px;
            padding: 2px;
        }
    </style>
</head>
<script type="application/javascript">
    const months = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль',
        'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];
    const weekDays = [
        'Воскресение', 'Понедельник', 'Вторник', 'Среда',
        'Четверг', 'Пятница', 'Суббота'
    ];
    var currentCalendarMonth = null;
    var prevActiveCell = null;
    var calendarItems = [];

    function CalendarDay(date, events) {
        this.id = [
            date.getFullYear(),
            date.getMonth(),
            date.getDate()
        ].join('_');
        this.date = date;
        this.from = resetTime(date);
        var to = resetTime(date);
        to = addDays( to, 1 );
        this.to = to - 1;
        this.events = [];
        if (events) {
            this.events = events;
        }
        this.weekDay = weekDays[date.getDay()];
    }

    function addDays( date, count ) {
        const dayInMs = 24 * 60 * 60 * 1000;
        return new Date( date.getTime() + ( count * dayInMs ) );
    }

    function getDayById(id) {
        var result = null;
        calendarItems.forEach( function(week) {
            week.forEach( function( day ) {
                if ( day.id === id ) {
                    result = day;
                }
            } );
        } );
        return result;
    }

    function resetTime( date ) {
        const reset = new Date(date);
        reset.setHours(0);
        reset.setMinutes(0);
        reset.setSeconds(0);
        reset.setMilliseconds(0);
        return reset;
    }

    function isSameDate( a, b ) {
        return a.getDate() === b.getDate() &&
            a.getMonth() === b.getMonth() &&
            a.getFullYear() === b.getFullYear();
    }

    function buildFromTo(month) {
        var start = new Date();
        var end = new Date();
        var diff = null;
        if (month) {
            start.setMonth(month);
            end.setMonth(month);
        }

        start.setDate(1);
        const startWeekDay = start.getDay();
        if (startWeekDay === 0) {
            diff = 6;
        } else if ( startWeekDay > 1 ) {
            diff = startWeekDay - 1;
        }
        const from = addDays(start, -1 * diff);

        end.setDate(1);
        end.setMonth(end.getMonth() + 1);
        end = addDays(end, -1);
        const endWeekDay = end.getDay();
        if ( endWeekDay > 0 ) {
            diff = 7 - endWeekDay;
        } else {
            diff = 0;
        }
        const to = addDays( end, diff );
        return { from: from, to: to };
    }

    function buildDays(month) {
        const weeks = [];
        const period = buildFromTo(month);
        var curr = period.from;
        while ( curr <= period.to ) {
            var ind = 0;
            var week = [];
            while (ind < 7) {
                ind += 1;
                week.push(new CalendarDay(curr));
                curr = addDays( curr, 1 );
            }
            weeks.push(week);
        }
        return weeks;
    }

    function drawDay( day, showDayOfWeek ) {
        var now = new Date();
        var number = ( showDayOfWeek ? day.weekDay + ', ' : '' ) + day.date.getDate();
        var events = '<div class="events">';
        day.events.forEach( function( value ) {
            events += '<span class="event title">' + value.name + '</span>';
            events += '<div class="event participants">' + value.participants + '</div>';
        } );
        events += '</div>';
        var cellClasses = 'cell';
        if ( isSameDate(day.date, now) ) {
            cellClasses+= ' current';
        }
        return [
            '<td class="', cellClasses, '" data-id="', day.id,'">',
            '<div class="cell-number">',number, '</div>',
            events,
            '</td>'
        ].join('');
    }

    function drawWeek( week, showDayOfWeek ) {
        var content = '';
        var l = week.length;
        for (var i=0;i<l;i++) {
            content += drawDay(week[i], showDayOfWeek);
        }
        return '<tr>' + content + '</tr>';
    }

    function drawCalendar(month, useOldDays) {
        var weeks;
        if (useOldDays) {
            weeks = calendarItems;
        } else {
            weeks = buildDays(month);
        }
        const calendar = document.querySelector('#calend');
        var content = '';
        const l = weeks.length;
        for (var i=0;i<l;i++) {
            content += drawWeek(weeks[i], i === 0);
        }
        calendar.innerHTML = content;
        if (month) {
            currentCalendarMonth = month;
        }
        calendarItems = weeks;
    }

    function updateDisplayDate( date ) {
        document.querySelector('.date').textContent = [
            months[ date.getMonth() ],
            date.getFullYear()
        ].join(' ');
    }

    function nextMonth() {
        debugger
        var date = new Date();
        date.setMonth(date.getMonth() + 1);
        if (currentCalendarMonth) {
            date.setMonth(currentCalendarMonth + 1);
        }
        if (!_loadFromLS(date)) {
            drawCalendar(date.getMonth());
        }
        updateDisplayDate(date);
    }

    function prevMonth() {
        debugger
        var date = new Date();
        date.setMonth(date.getMonth() - 1);
        if (currentCalendarMonth) {
            date.setMonth(currentCalendarMonth - 1);
        }
        if (!_loadFromLS(date)) {
            drawCalendar(date.getMonth());
        }
        updateDisplayDate(date);
    }

    function currentMonth() {
        if (!_loadFromLS((new Date))) {
            drawCalendar((new Date).getMonth());
        }
        updateDisplayDate(new Date);
    }

    function getValueBySelector(src, selector, def) {
        var node = src.querySelector(selector);
        if ( node && node.value ) {
            return node.value;
        }
        return def || '';
    }

    function resetField(src, selector) {
        var node = src.querySelector(selector);
        if ( node && node.value ) {
            return node.value = '';
        }
    }

    function removeModalForm() {
        document.querySelectorAll('.calendar .modal-form').forEach(x => x.remove());
    }

    function addEvent( cell ) {
        var day = getDayById(cell.dataset.id);
        var modal = cell.querySelector('.modal-form');
        var eventName = getValueBySelector( modal, '.event' );
        var participants = getValueBySelector(modal, '.participants');
        var description = getValueBySelector(modal, '.description');
        day.events.push( {
            name: eventName,
            participants: participants,
            description: description
        } );
        _saveToLS(day.date.getMonth());
        drawCalendar(null, true);
    }

    function showModalForm(cell) {
        removeModalForm();
        var modal = document.querySelector('.modal-form');
        var clModal = modal.cloneNode(true);
        cell.appendChild(clModal);
        var cellRect = cell.getClientRects();
        clModal.style.left = cellRect[0].left + cell.clientWidth + 5 + 'px';
        clModal.style.top = cellRect[0].top + 10 + 'px';
        clModal.style.display = 'block';
    }

    function _handleCellClick( cell ) {
        if ( cell.className.indexOf( 'active' ) >=0 ) {
            removeModalForm();
            cell.className = cell.className.replace( ' active', '' );
            return;
        }
        if ( prevActiveCell ) {
            prevActiveCell.className = prevActiveCell.className.replace( ' active', '' );
        }
        cell.className += ' active';
        prevActiveCell = cell;
        showModalForm(cell);
    }

    function _loadFromLS(date) {
        var calendData = localStorage.getItem('calend_' + date.getMonth());
        if (!calendData) {
            return false;
        }
        var normalizedData = JSON.parse(calendData);
        var weeks = [];
        for (var i=0;i<normalizedData.length;i++) {
            var normalizedWeek = normalizedData[i];
            var week = [];
            for (var j=0;j<normalizedWeek.length;j++) {
                var day = normalizedWeek[j];
                week.push(new CalendarDay(new Date(day.date), day.events))
            }
            weeks.push(week);
        }
        calendarItems = weeks;
        drawCalendar(date.getMonth(), true);
        return true;
    }

    function _saveToLS(month) {
        var serializedData = JSON.stringify(calendarItems);
        localStorage.setItem('calend_' + month, serializedData);
    }

    function startCalendar() {
        const today = new Date();
        updateDisplayDate(today);
        const prevBtn = document.querySelector('.nav-btn.left');
        prevBtn.addEventListener('click', prevMonth);
        const nextBtn = document.querySelector('.nav-btn.right');
        nextBtn.addEventListener('click', nextMonth);
        const currBtn = document.querySelector('.nav-btn.today');
        currBtn.addEventListener('click', currentMonth);
        if (!_loadFromLS(today)) {
            drawCalendar();
        }
        document.addEventListener('click', function( event ) {
            const target = event.target;
            if (target.tagName.toLowerCase() === 'td') {
                _handleCellClick(target);
            }
            if (['events', 'cell-number'].indexOf(target.className) >=0) {
                _handleCellClick(target.parentElement);
            }

            if (target.className.split(' ').indexOf('modal-close') >= 0) {
                removeModalForm();
            }
            if (target.className.split(' ').indexOf('add-event') >=0) {
                addEvent(target.parentElement.parentElement.parentElement);
            }
        });
    }
    window.onload = startCalendar;
</script>
<body>
    <div id="app">
        <div class="header">
            <div class="controls">
                <button>Добавить</button>
                <button>Обновить</button>
            </div>
            <div class="search">
                <i></i>
                <input type="text" placeholder="Событие, дата или участник">
            </div>
        </div>
        <div class="container">
            <div class="navigation">
                <div class="nav-btn left">
                    <
                </div>
                <span class="date"></span>
                <div class="nav-btn right">
                    >
                </div>
                <div class="nav-btn today">
                    Сегодня
                </div>
            </div>
            <div class="calendar">
                <table>
                    <tbody id="calend">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-form">
        <span class="modal-close icon">х</span>
        <form action="">
            <div class="field-container">
                <input class="input-field event" type="text" placeholder="Событие" />
            </div>
            <div class="field-container">
                <input class="input-field date" type="text" placeholder="День, месяц, год" />
            </div>
            <div class="field-container">
                <input class="input-field participants" type="text" placeholder="Участиники" />
            </div>
            <div class="field-container descr">
                <textarea class="text-field description" placeholder="Описание"></textarea>
            </div>
            <button class="add-event">Готово</button>
            <button class="modal-close">Отмена</button>
        </form>
    </div>
</body>
</html>